!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).OURO={})}(this,(function(t){"use strict";class e{}class s{constructor(t,e={}){this.creation=t,this.episodeList=e.episodeList?e.episodeList:[],this.index=0,this.activeEpisode=null,this.nextEpisode=null,this.lastEpisode=null}start(){this.activeEpisode=new this.episodeList[this.index](this.creation),this.startActiveEpisode()}pause(){}stop(){}iterateIndex(){return this.index+=1,this.index}setActiveEpisode(){this.lastEpisode=this.activeEpisode,this.activeEpisode=this.nextEpisode,this.nextEpisode=this.episodeList[this.iterateIndex()],this.creation.renderer.add,this.unloadLastEpisode()}loadNextEpisode(){this.nextEpisode=new this.nextEpisode(this.creation)}unloadLastEpisode(){this.lastEpisode.dispose(),this.lastEpisode=null}startActiveEpisode(){this.activeEpisode.start()}endActiveEpisode(){this.activeEpisode.stop()}render(){this.activeEpisode.render()}}class i{constructor(t,e={}){this.creation=t,this.sceneList=e.sceneList?e.sceneList:[],this.index=e.index?e.index:0,this.activeScene=null,this.lastScene=null,this.nextScene=null}iterateIndex(){return this.index+=1,this.index}iterateScene(){this.lastScene=this.activeScene,this.activeScene=this.nextScene,this.setNextScene(),this.iterateIndex(),this.unloadLastScene()}setNextScene(t=this.index+1){this.nextScene=this.sceneList[t]}loadNextScene(){this.nextScene&&(this.nextScene=new this.nextScene(this.creation))}unloadLastScene(){this.lastScene.dispose(),this.lastScene=null}startActiveScene(){this.activeScene.start()}endActiveScene(){this.activeScene.stop(),this.loadNextScene(),this.iterateScene()}start(){this.activeScene=new this.sceneList[this.index](this.creation),this.setNextScene()}render(){this.activeScene.render&&this.activeScene.render()}}class r{constructor(t,e={}){this.creation=t,this.scene=new THREE.Scene,this.scene.fog=new THREE.FogExp2(2105376,.025),this.camera=new THREE.PerspectiveCamera(55,this.creation.canvas.clientWidth/this.creation.canvas.clientHeight,.1,1e3),this.setAspect(),window.addEventListener("resize",(()=>{this.setAspect()}),!1),this.map=new THREE.Object3D,this.scene.add(this.map),this.world=new CANNON.World,this.world.gravity.set(0,-9.82,0),this.world.broadphase=new CANNON.NaiveBroadphase,this.debugrenderer=new THREE.CannonDebugRenderer(this.scene,this.world)}add(t){this.scene.add(t.mesh),this.world.addBody(t.body)}start(){}end(){}update(){}setAspect(){this.camera.aspect=this.creation.canvas.clientWidth/this.creation.canvas.clientHeight,this.camera.updateProjectionMatrix(),this.creation.renderer.setSize(this.creation.canvas.clientWidth,this.creation.canvas.clientHeight)}render(){this.update(),this.world.step(1/60,this.creation.tickDelta,3),this.creation.renderer.render(this.scene,this.camera)}dispose(){this.scene=null,this.camera=null,this.render=null}}class n{constructor(t,e={}){this.creation=t,this.mtl=e.mtl??null,this.geo=e.geo??null,this.mesh=e.mesh??new THREE.Mesh(this.geo,this.mtl),this.body=e.body??new CANNON.Body({mass:e.mass??1,shape:e.shape??null})}updatePosition(){this.mesh.position.copy(this.body.position),this.mesh.quaternion.copy(this.body.quaternion)}}class o extends n{constructor(t,e){e.texture=t.texLoader.load(e.texture?e.texture:"./../assets/textures/explosion.png"),e.complexity=e.detail??4,e.timeScale=e.timeScale??.025,e.turbScale=19,e.coreMat=new THREE.ShaderMaterial({uniforms:{tExplosion:{type:"t",value:e.texture},time:{type:"f",value:0},turbScale:{type:"f",value:e.turbScale}},vertexShader:coreVShader(),fragmentShader:coreFShader()}),e.body=new CANNON.Body({shape:new CANNON.Sphere(1),mass:4}),e.model=new THREE.Mesh(new THREE.IcosahedronBufferGeometry(.9,e.complexity),e.coreMat),e.mesh=new THREE.Object3D,super(t,e),this.model=e.model,this.mesh.add(this.model),this.model.position.x=.35,this.texture=e.texture.dispose(),this.complexity=e.complexity,this.timeScale=e.timeScale,this.turbScale=e.turbScale,this.coreMat=e.coreMat}updateTime(t){this.coreMat.uniforms.time.value=t}updateTimeScale(t){this.timeScale=t}updateTexture(t){this.coreMat.uniforms.tExplosion.value=this.texture=mg.tex.load(t)}updateTurbScale(t){this.coreMat.uniforms.turbScale.value=this.turbScale=t}update(){this.updateTime(this.creation.tick*this.timeScale)}}class a{constructor(t,e,s){this.creation=t,this.camera=e,this.target=s,this.forward=!1,this.left=!1,this.right=!1,this.backward=!1,this.jump=!1,this.canJump=!0,this.isJumping=!1,this.f=new THREE.Vector3,this.keypressed=null,this.keyreleased=null,this.mousemove=null,this.pointerLock=null,this.hasPointerLock="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document,this.pointerlockchange=null,this.pointerlockerror=null,this.element=null,this.hasPointerLock&&(this.element=document.body,this.pointerLock=new THREE.PointerLockOrbitControls(this.camera,this.target,this.creation.tickDelta,this.element),this.pointerlockchange=t=>{document.pointerLockElement===this.element||document.mozPointerLockElement===this.element||document.webkitPointerLockElement===this.element?this.pointerLock.enabled=!0:this.pointerLock.enabled=!1},this.pointerlockerror=function(t){},this.keyPressed=t=>{switch(t.keyCode){case 87:this.forward=!0;break;case 65:this.left=!0;break;case 83:this.backward=!0;break;case 68:this.right=!0;break;case 32:this.jump=!0}},this.keyReleased=t=>{switch(t.keyCode){case 87:this.forward=!1;break;case 65:this.left=!1;break;case 83:this.backward=!1;break;case 68:this.right=!1;break;case 32:this.jump=!1}},document.addEventListener("pointerlockchange",this.pointerlockchange,!1),document.addEventListener("mozpointerlockchange",this.pointerlockchange,!1),document.addEventListener("webkitpointerlockchange",this.pointerlockchange,!1),document.addEventListener("pointerlockerror",this.pointerlockerror,!1),document.addEventListener("mozpointerlockerror",this.pointerlockerror,!1),document.addEventListener("webkitpointerlockerror",this.pointerlockerror,!1),this.element.addEventListener("click",(t=>{this.element.requestPointerLock=this.element.requestPointerLock||this.element.mozRequestPointerLock||this.element.webkitRequestPointerLock,this.element.requestPointerLock()}),!1),window.addEventListener("keydown",this.keyPressed),window.addEventListener("keyup",this.keyReleased))}getForce(){return this.f.multiplyScalar(0),this.forward&&(this.f.z-=1),this.backward&&(this.f.z+=1),this.left&&(this.f.x-=1),this.right&&(this.f.x+=1),this.f.applyQuaternion(this.camera.quaternion),this.f.y=0,this.jump&&(!this.isJumping&&this.canJump&&(this.isJumping=!0,setTimeout((()=>{this.canJump=!1,setTimeout((()=>{this.canJump=!0,this.isJumping=!1}),1e3)}),200)),this.isJumping&&this.canJump&&(this.f.y+=5)),this.f}update(){this.pointerLock.updateTimeElapsed(this.creation.tickDelta),this.pointerLock.update()}}class h{static setLevel(t){c=t}static log(...t){c<=h.LEVEL.LOG&&console.log(...t)}static warn(...t){c<=h.LEVEL.WARN&&console.warn(...t)}static error(...t){c<=h.LEVEL.ERROR&&console.error(...t)}}h.LEVEL=Object.freeze({LOG:0,WARN:1,ERROR:2,SILENT:3});let c=h.LEVEL.WARN;const l=new Array;for(let t=0;t<256;t++)l[t]=(t<16?"0":"")+t.toString(16);class u{static clamp(t,e,s){return Math.max(e,Math.min(s,t))}static randInt(t,e){return t+Math.floor(Math.random()*(e-t+1))}static randFloat(t,e){return t+Math.random()*(e-t)}static area(t,e,s){return(s.x-t.x)*(e.z-t.z)-(e.x-t.x)*(s.z-t.z)}static generateUUID(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,s=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(l[255&t]+l[t>>8&255]+l[t>>16&255]+l[t>>24&255]+"-"+l[255&e]+l[e>>8&255]+"-"+l[e>>16&15|64]+l[e>>24&255]+"-"+l[63&s|128]+l[s>>8&255]+"-"+l[s>>16&255]+l[s>>24&255]+l[255&i]+l[i>>8&255]+l[i>>16&255]+l[i>>24&255]).toUpperCase()}}class d{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}clone(){return(new this.constructor).copy(this)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.x/=t,this.y/=t,this.z/=t,this}divideVectors(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}reflect(t){return this.sub(p.copy(t).multiplyScalar(2*this.dot(t)))}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){const e=this.x,s=this.y,i=this.z;return this.x=s*t.z-i*t.y,this.y=i*t.x-e*t.z,this.z=e*t.y-s*t.x,this}crossVectors(t,e){const s=t.x,i=t.y,r=t.z,n=e.x,o=e.y,a=e.z;return this.x=i*a-r*o,this.y=r*n-s*a,this.z=s*o-i*n,this}angleTo(t){const e=Math.sqrt(this.squaredLength()*t.squaredLength());if(0===e)return 0;const s=this.dot(t)/e;return Math.acos(u.clamp(s,-1,1))}length(){return Math.sqrt(this.squaredLength())}squaredLength(){return this.dot(this)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}distanceTo(t){return Math.sqrt(this.squaredDistanceTo(t))}squaredDistanceTo(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return e*e+s*s+i*i}manhattanDistanceTo(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return Math.abs(e)+Math.abs(s)+Math.abs(i)}normalize(){return this.divideScalar(this.length()||1)}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,r=t.elements,n=1/(r[3]*e+r[7]*s+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*s+r[8]*i+r[12])*n,this.y=(r[1]*e+r[5]*s+r[9]*i+r[13])*n,this.z=(r[2]*e+r[6]*s+r[10]*i+r[14])*n,this}applyRotation(t){const e=this.x,s=this.y,i=this.z,r=t.x,n=t.y,o=t.z,a=t.w,h=a*e+n*i-o*s,c=a*s+o*e-r*i,l=a*i+r*s-n*e,u=-r*e-n*s-o*i;return this.x=h*a+u*-r+c*-o-l*-n,this.y=c*a+u*-n+l*-r-h*-o,this.z=l*a+u*-o+h*-n-c*-r,this}extractPositionFromMatrix(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}transformDirection(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*s+r[8]*i,this.y=r[1]*e+r[5]*s+r[9]*i,this.z=r[2]*e+r[6]*s+r[10]*i,this.normalize()}fromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}fromMatrix4Column(t,e){return this.fromArray(t.elements,4*e)}fromSpherical(t,e,s){const i=Math.sin(e)*t;return this.x=i*Math.sin(s),this.y=Math.cos(e)*t,this.z=i*Math.cos(s),this}fromArray(t,e=0){return this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this}toArray(t,e=0){return t[e+0]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}}const p=new d,m=new d(0,1,0),y=new d,g=new d,x=new d,f=new d,w=[2,2,1],S=[1,0,0];class M{constructor(){this.elements=[1,0,0,0,1,0,0,0,1]}set(t,e,s,i,r,n,o,a,h){const c=this.elements;return c[0]=t,c[3]=e,c[6]=s,c[1]=i,c[4]=r,c[7]=n,c[2]=o,c[5]=a,c[8]=h,this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}clone(){return(new this.constructor).copy(this)}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],o=s[3],a=s[6],h=s[1],c=s[4],l=s[7],u=s[2],d=s[5],p=s[8],m=i[0],y=i[3],g=i[6],x=i[1],f=i[4],w=i[7],S=i[2],M=i[5],b=i[8];return r[0]=n*m+o*x+a*S,r[3]=n*y+o*f+a*M,r[6]=n*g+o*w+a*b,r[1]=h*m+c*x+l*S,r[4]=h*y+c*f+l*M,r[7]=h*g+c*w+l*b,r[2]=u*m+d*x+p*S,r[5]=u*y+d*f+p*M,r[8]=u*g+d*w+p*b,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}extractBasis(t,e,s){return t.fromMatrix3Column(this,0),e.fromMatrix3Column(this,1),s.fromMatrix3Column(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,t.y,e.y,s.y,t.z,e.z,s.z),this}lookAt(t,e,s){return y.crossVectors(s,t).normalize(),g.crossVectors(m,e).normalize(),0===g.squaredLength()&&(f.copy(e).addScalar(Number.EPSILON),g.crossVectors(m,f).normalize()),x.crossVectors(e,g).normalize(),b.makeBasis(g,x,e),v.makeBasis(y,s,t),this.multiplyMatrices(b,v.transpose()),this}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getElementIndex(t,e){return 3*t+e}frobeniusNorm(){const t=this.elements;let e=0;for(let s=0;s<9;s++)e+=t[s]*t[s];return Math.sqrt(e)}offDiagonalFrobeniusNorm(){const t=this.elements;let e=0;for(let s=0;s<3;s++){const i=t[this.getElementIndex(w[s],S[s])];e+=2*i*i}return Math.sqrt(e)}eigenDecomposition(t){let e=0,s=0;t.unitary.identity(),t.diagonal.copy(this);const i=t.unitary,r=t.diagonal,n=Number.EPSILON*r.frobeniusNorm();for(;s<10&&r.offDiagonalFrobeniusNorm()>n;)r.shurDecomposition(b),v.copy(b).transpose(),r.multiply(b),r.premultiply(v),i.multiply(b),++e>2&&(s++,e=0);return t}shurDecomposition(t){let e=0,s=1;const i=this.elements;for(let t=0;t<3;t++){const r=Math.abs(i[this.getElementIndex(w[t],S[t])]);r>e&&(e=r,s=t)}let r=1,n=0;const o=S[s],a=w[s];if(Math.abs(i[this.getElementIndex(a,o)])>Number.EPSILON){const t=(i[this.getElementIndex(a,a)]-i[this.getElementIndex(o,o)])/2/i[this.getElementIndex(a,o)];let e;e=t<0?-1/(-t+Math.sqrt(1+t*t)):1/(t+Math.sqrt(1+t*t)),r=1/Math.sqrt(1+e*e),n=e*r}return t.identity(),t.elements[this.getElementIndex(o,o)]=r,t.elements[this.getElementIndex(a,a)]=r,t.elements[this.getElementIndex(a,o)]=n,t.elements[this.getElementIndex(o,a)]=-n,t}fromQuaternion(t){const e=this.elements,s=t.x,i=t.y,r=t.z,n=t.w,o=s+s,a=i+i,h=r+r,c=s*o,l=s*a,u=s*h,d=i*a,p=i*h,m=r*h,y=n*o,g=n*a,x=n*h;return e[0]=1-(d+m),e[3]=l-x,e[6]=u+g,e[1]=l+x,e[4]=1-(c+m),e[7]=p-y,e[2]=u-g,e[5]=p+y,e[8]=1-(c+d),this}fromMatrix4(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[4],e[4]=s[5],e[5]=s[6],e[6]=s[8],e[7]=s[9],e[8]=s[10],this}fromArray(t,e=0){const s=this.elements;for(let i=0;i<9;i++)s[i]=t[i+e];return this}toArray(t,e=0){const s=this.elements;return t[e+0]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<9;t++)if(e[t]!==s[t])return!1;return!0}}const b=new M,v=new M,z=new M,E=new d;class O{constructor(t=0,e=0,s=0,i=1){this.x=t,this.y=e,this.z=s,this.w=i}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}clone(){return(new this.constructor).copy(this)}inverse(){return this.conjugate().normalize()}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}length(){return Math.sqrt(this.squaredLength())}squaredLength(){return this.dot(this)}normalize(){let t=this.length();return 0===t?(this.x=0,this.y=0,this.z=0,this.w=1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t.x,i=t.y,r=t.z,n=t.w,o=e.x,a=e.y,h=e.z,c=e.w;return this.x=s*c+n*o+i*h-r*a,this.y=i*c+n*a+r*o-s*h,this.z=r*c+n*h+s*a-i*o,this.w=n*c-s*o-i*a-r*h,this}angleTo(t){return 2*Math.acos(Math.abs(u.clamp(this.dot(t),-1,1)))}rotateTo(t,e,s=1e-4){const i=this.angleTo(t);if(i<s)return!0;const r=Math.min(1,e/i);return this.slerp(t,r),!1}lookAt(t,e,s){z.lookAt(t,e,s),this.fromMatrix3(z)}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const s=this.x,i=this.y,r=this.z,n=this.w;let o=n*t.w+s*t.x+i*t.y+r*t.z;if(o<0?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,o=-o):this.copy(t),o>=1)return this.w=n,this.x=s,this.y=i,this.z=r,this;const a=Math.sqrt(1-o*o);if(Math.abs(a)<.001)return this.w=.5*(n+this.w),this.x=.5*(s+this.x),this.y=.5*(i+this.y),this.z=.5*(r+this.z),this;const h=Math.atan2(a,o),c=Math.sin((1-e)*h)/a,l=Math.sin(e*h)/a;return this.w=n*c+this.w*l,this.x=s*c+this.x*l,this.y=i*c+this.y*l,this.z=r*c+this.z*l,this}extractRotationFromMatrix(t){const e=z.elements,s=t.elements,i=1/E.fromMatrix4Column(t,0).length(),r=1/E.fromMatrix4Column(t,1).length(),n=1/E.fromMatrix4Column(t,2).length();return e[0]=s[0]*i,e[1]=s[1]*i,e[2]=s[2]*i,e[3]=s[4]*r,e[4]=s[5]*r,e[5]=s[6]*r,e[6]=s[8]*n,e[7]=s[9]*n,e[8]=s[10]*n,this.fromMatrix3(z),this}fromEuler(t,e,s){const i=Math.cos(e/2),r=Math.cos(t/2),n=Math.cos(s/2),o=Math.sin(e/2),a=Math.sin(t/2),h=Math.sin(s/2);return this.w=i*r*n+o*a*h,this.x=i*a*n+o*r*h,this.y=o*r*n-i*a*h,this.z=i*r*h-o*a*n,this}toEuler(t){const e=-2*(this.y*this.z-this.x*this.w);return Math.abs(e)>.9999?(t.x=.5*Math.PI*e,t.y=Math.atan2(this.x*this.z+this.w*this.y,.5-this.x*this.x-this.y*this.y),t.z=0):(t.x=Math.asin(e),t.y=Math.atan2(this.x*this.z+this.w*this.y,.5-this.x*this.x-this.y*this.y),t.z=Math.atan2(this.x*this.y+this.w*this.z,.5-this.x*this.x-this.z*this.z)),t}fromMatrix3(t){const e=t.elements,s=e[0],i=e[3],r=e[6],n=e[1],o=e[4],a=e[7],h=e[2],c=e[5],l=e[8],u=s+o+l;if(u>0){let t=.5/Math.sqrt(u+1);this.w=.25/t,this.x=(c-a)*t,this.y=(r-h)*t,this.z=(n-i)*t}else if(s>o&&s>l){let t=2*Math.sqrt(1+s-o-l);this.w=(c-a)/t,this.x=.25*t,this.y=(i+n)/t,this.z=(r+h)/t}else if(o>l){let t=2*Math.sqrt(1+o-s-l);this.w=(r-h)/t,this.x=(i+n)/t,this.y=.25*t,this.z=(a+c)/t}else{let t=2*Math.sqrt(1+l-s-o);this.w=(n-i)/t,this.x=(r+h)/t,this.y=(a+c)/t,this.z=.25*t}return this}fromArray(t,e=0){return this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t,e=0){return t[e+0]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}}class N{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}set(t,e,s,i,r,n,o,a,h,c,l,u,d,p,m,y){const g=this.elements;return g[0]=t,g[4]=e,g[8]=s,g[12]=i,g[1]=r,g[5]=n,g[9]=o,g[13]=a,g[2]=h,g[6]=c,g[10]=l,g[14]=u,g[3]=d,g[7]=p,g[11]=m,g[15]=y,this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}clone(){return(new this.constructor).copy(this)}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],o=s[4],a=s[8],h=s[12],c=s[1],l=s[5],u=s[9],d=s[13],p=s[2],m=s[6],y=s[10],g=s[14],x=s[3],f=s[7],w=s[11],S=s[15],M=i[0],b=i[4],v=i[8],z=i[12],E=i[1],O=i[5],N=i[9],A=i[13],T=i[2],R=i[6],L=i[10],k=i[14],_=i[3],J=i[7],D=i[11],C=i[15];return r[0]=n*M+o*E+a*T+h*_,r[4]=n*b+o*O+a*R+h*J,r[8]=n*v+o*N+a*L+h*D,r[12]=n*z+o*A+a*k+h*C,r[1]=c*M+l*E+u*T+d*_,r[5]=c*b+l*O+u*R+d*J,r[9]=c*v+l*N+u*L+d*D,r[13]=c*z+l*A+u*k+d*C,r[2]=p*M+m*E+y*T+g*_,r[6]=p*b+m*O+y*R+g*J,r[10]=p*v+m*N+y*L+g*D,r[14]=p*z+m*A+y*k+g*C,r[3]=x*M+f*E+w*T+S*_,r[7]=x*b+f*O+w*R+S*J,r[11]=x*v+f*N+w*L+S*D,r[15]=x*z+f*A+w*k+S*C,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}extractBasis(t,e,s){return t.fromMatrix4Column(this,0),e.fromMatrix4Column(this,1),s.fromMatrix4Column(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}compose(t,e,s){return this.fromQuaternion(e),this.scale(s),this.setPosition(t),this}scale(t){const e=this.elements,s=t.x,i=t.y,r=t.z;return e[0]*=s,e[4]*=i,e[8]*=r,e[1]*=s,e[5]*=i,e[9]*=r,e[2]*=s,e[6]*=i,e[10]*=r,e[3]*=s,e[7]*=i,e[11]*=r,this}setPosition(t){const e=this.elements;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}getInverse(t){const e=this.elements,s=t.elements,i=e[0],r=e[1],n=e[2],o=e[3],a=e[4],h=e[5],c=e[6],l=e[7],u=e[8],d=e[9],p=e[10],m=e[11],y=e[12],g=e[13],x=e[14],f=e[15],w=d*x*l-g*p*l+g*c*m-h*x*m-d*c*f+h*p*f,S=y*p*l-u*x*l-y*c*m+a*x*m+u*c*f-a*p*f,M=u*g*l-y*d*l+y*h*m-a*g*m-u*h*f+a*d*f,b=y*d*c-u*g*c-y*h*p+a*g*p+u*h*x-a*d*x,v=i*w+r*S+n*M+o*b;if(0===v)return t.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const z=1/v;return s[0]=w*z,s[1]=(g*p*o-d*x*o-g*n*m+r*x*m+d*n*f-r*p*f)*z,s[2]=(h*x*o-g*c*o+g*n*l-r*x*l-h*n*f+r*c*f)*z,s[3]=(d*c*o-h*p*o-d*n*l+r*p*l+h*n*m-r*c*m)*z,s[4]=S*z,s[5]=(u*x*o-y*p*o+y*n*m-i*x*m-u*n*f+i*p*f)*z,s[6]=(y*c*o-a*x*o-y*n*l+i*x*l+a*n*f-i*c*f)*z,s[7]=(a*p*o-u*c*o+u*n*l-i*p*l-a*n*m+i*c*m)*z,s[8]=M*z,s[9]=(y*d*o-u*g*o-y*r*m+i*g*m+u*r*f-i*d*f)*z,s[10]=(a*g*o-y*h*o+y*r*l-i*g*l-a*r*f+i*h*f)*z,s[11]=(u*h*o-a*d*o-u*r*l+i*d*l+a*r*m-i*h*m)*z,s[12]=b*z,s[13]=(u*g*n-y*d*n+y*r*p-i*g*p-u*r*x+i*d*x)*z,s[14]=(y*h*n-a*g*n-y*r*c+i*g*c+a*r*x-i*h*x)*z,s[15]=(a*d*n-u*h*n+u*r*c-i*d*c-a*r*p+i*h*p)*z,t}getMaxScale(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,i))}fromQuaternion(t){const e=this.elements,s=t.x,i=t.y,r=t.z,n=t.w,o=s+s,a=i+i,h=r+r,c=s*o,l=s*a,u=s*h,d=i*a,p=i*h,m=r*h,y=n*o,g=n*a,x=n*h;return e[0]=1-(d+m),e[4]=l-x,e[8]=u+g,e[1]=l+x,e[5]=1-(c+m),e[9]=p-y,e[2]=u-g,e[6]=p+y,e[10]=1-(c+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}fromMatrix3(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=0,e[4]=s[3],e[5]=s[4],e[6]=s[5],e[7]=0,e[8]=s[6],e[9]=s[7],e[10]=s[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}fromArray(t,e=0){const s=this.elements;for(let i=0;i<16;i++)s[i]=t[i+e];return this}toArray(t,e=0){const s=this.elements;return t[e+0]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<16;t++)if(e[t]!==s[t])return!1;return!0}}const A=new O,T=new d,R=new O;class L{constructor(){this.name="",this.active=!0,this.children=new Array,this.parent=null,this.neighbors=new Array,this.neighborhoodRadius=1,this.updateNeighborhood=!1,this.position=new d,this.rotation=new O,this.scale=new d(1,1,1),this.forward=new d(0,0,1),this.up=new d(0,1,0),this.boundingRadius=0,this.maxTurnRate=Math.PI,this.canActivateTrigger=!0,this.worldMatrix=new N,this.manager=null,this._localMatrix=new N,this._cache={position:new d,rotation:new O,scale:new d(1,1,1)},this._renderComponent=null,this._renderComponentCallback=null,this._started=!1,this._uuid=null}get uuid(){return null===this._uuid&&(this._uuid=u.generateUUID()),this._uuid}set uuid(t){this._uuid=t}start(){}update(){}add(t){return null!==t.parent&&t.parent.remove(t),this.children.push(t),t.parent=this,this}remove(t){const e=this.children.indexOf(t);return this.children.splice(e,1),t.parent=null,this}getDirection(t){return t.copy(this.forward).applyRotation(this.rotation).normalize()}lookAt(t){return T.subVectors(t,this.position).normalize(),this.rotation.lookAt(this.forward,T,this.up),this}rotateTo(t,e,s=1e-4){return T.subVectors(t,this.position).normalize(),A.lookAt(this.forward,T,this.up),this.rotation.rotateTo(A,this.maxTurnRate*e,s)}getWorldDirection(t){return R.extractRotationFromMatrix(this.worldMatrix),t.copy(this.forward).applyRotation(R).normalize()}getWorldPosition(t){return t.extractPositionFromMatrix(this.worldMatrix)}updateWorldMatrix(t=!1,e=!1){const s=this.parent,i=this.children;if(!0===t&&null!==s&&s.updateWorldMatrix(!0),this._updateMatrix(),null===s?this.worldMatrix.copy(this._localMatrix):this.worldMatrix.multiplyMatrices(this.parent.worldMatrix,this._localMatrix),!0===e)for(let t=0,e=i.length;t<e;t++){i[t].updateWorldMatrix(!1,!0)}return this}setRenderComponent(t,e){return this._renderComponent=t,this._renderComponentCallback=e,this}handleMessage(){return!1}lineOfSightTest(){return null}sendMessage(t,e,s=0,i=null){return null!==this.manager?this.manager.sendMessage(this,t,e,s,i):h.error("YUKA.GameEntity: The game entity must be added to a manager in order to send a message."),this}toJSON(){return{type:this.constructor.name,uuid:this.uuid,name:this.name,active:this.active,children:k(this.children),parent:null!==this.parent?this.parent.uuid:null,neighbors:k(this.neighbors),neighborhoodRadius:this.neighborhoodRadius,updateNeighborhood:this.updateNeighborhood,position:this.position.toArray(new Array),rotation:this.rotation.toArray(new Array),scale:this.scale.toArray(new Array),forward:this.forward.toArray(new Array),up:this.up.toArray(new Array),boundingRadius:this.boundingRadius,maxTurnRate:this.maxTurnRate,canActivateTrigger:this.canActivateTrigger,worldMatrix:this.worldMatrix.toArray(new Array),_localMatrix:this._localMatrix.toArray(new Array),_cache:{position:this._cache.position.toArray(new Array),rotation:this._cache.rotation.toArray(new Array),scale:this._cache.scale.toArray(new Array)},_started:this._started}}fromJSON(t){return this.uuid=t.uuid,this.name=t.name,this.active=t.active,this.neighborhoodRadius=t.neighborhoodRadius,this.updateNeighborhood=t.updateNeighborhood,this.position.fromArray(t.position),this.rotation.fromArray(t.rotation),this.scale.fromArray(t.scale),this.forward.fromArray(t.forward),this.up.fromArray(t.up),this.boundingRadius=t.boundingRadius,this.maxTurnRate=t.maxTurnRate,this.canActivateTrigger=t.canActivateTrigger,this.worldMatrix.fromArray(t.worldMatrix),this.children=t.children.slice(),this.neighbors=t.neighbors.slice(),this.parent=t.parent,this._localMatrix.fromArray(t._localMatrix),this._cache.position.fromArray(t._cache.position),this._cache.rotation.fromArray(t._cache.rotation),this._cache.scale.fromArray(t._cache.scale),this._started=t._started,this}resolveReferences(t){const e=this.neighbors;for(let s=0,i=e.length;s<i;s++)e[s]=t.get(e[s]);const s=this.children;for(let e=0,i=s.length;e<i;e++)s[e]=t.get(s[e]);return this.parent=t.get(this.parent)||null,this}_updateMatrix(){const t=this._cache;return t.position.equals(this.position)&&t.rotation.equals(this.rotation)&&t.scale.equals(this.scale)||(this._localMatrix.compose(this.position,this.rotation,this.scale),t.position.copy(this.position),t.rotation.copy(this.rotation),t.scale.copy(this.scale)),this}}function k(t){const e=new Array;for(let s=0,i=t.length;s<i;s++)e.push(t[s].uuid);return e}const _=new d,J=new d;class D extends L{constructor(){super(),this.velocity=new d,this.maxSpeed=1,this.updateOrientation=!0}update(t){return this.getSpeedSquared()>this.maxSpeed*this.maxSpeed&&(this.velocity.normalize(),this.velocity.multiplyScalar(this.maxSpeed)),_.copy(this.velocity).multiplyScalar(t),J.copy(this.position).add(_),this.updateOrientation&&this.getSpeedSquared()>1e-8&&this.lookAt(J),this.position.copy(J),this}getSpeed(){return this.velocity.length()}getSpeedSquared(){return this.velocity.squaredLength()}toJSON(){const t=super.toJSON();return t.velocity=this.velocity.toArray(new Array),t.maxSpeed=this.maxSpeed,t.updateOrientation=this.updateOrientation,t}fromJSON(t){return super.fromJSON(t),this.velocity.fromArray(t.velocity),this.maxSpeed=t.maxSpeed,this.updateOrientation=t.updateOrientation,this}}class C{constructor(){this.active=!0,this.weight=1}calculate(){}toJSON(){return{type:this.constructor.name,active:this.active,weight:this.weight}}fromJSON(t){return this.active=t.active,this.weight=t.weight,this}resolveReferences(){}}const P=new d,F=new d;class V extends C{constructor(){super()}calculate(t,e){P.set(0,0,0);const s=t.neighbors;for(let t=0,e=s.length;t<e;t++){s[t].getDirection(F),P.add(F)}return s.length>0&&(P.divideScalar(s.length),t.getDirection(F),e.subVectors(P,F)),e}}const B=new d,I=new d;class q extends C{constructor(t=new d,e=3,s=0){super(),this.target=t,this.deceleration=e,this.tolerance=s}calculate(t,e){const s=this.target,i=this.deceleration;I.subVectors(s,t.position);const r=I.length();if(r>this.tolerance){let e=r/i;e=Math.min(e,t.maxSpeed),B.copy(I).multiplyScalar(e/r)}else B.set(0,0,0);return e.subVectors(B,t.velocity)}toJSON(){const t=super.toJSON();return t.target=this.target.toArray(new Array),t.deceleration=this.deceleration,t}fromJSON(t){return super.fromJSON(t),this.target.fromArray(t.target),this.deceleration=t.deceleration,this}}const U=new d;class H extends C{constructor(t=new d){super(),this.target=t}calculate(t,e){const s=this.target;return U.subVectors(s,t.position).normalize(),U.multiplyScalar(t.maxSpeed),e.subVectors(U,t.velocity)}toJSON(){const t=super.toJSON();return t.target=this.target.toArray(new Array),t}fromJSON(t){return super.fromJSON(t),this.target.fromArray(t.target),this}}const W=new d;class G extends C{constructor(){super(),this._seek=new H}calculate(t,e){W.set(0,0,0);const s=t.neighbors;for(let t=0,e=s.length;t<e;t++){const e=s[t];W.add(e.position)}return s.length>0&&(W.divideScalar(s.length),this._seek.target=W,this._seek.calculate(t,e),e.normalize()),e}}const K=new d;class Y extends C{constructor(t=new d,e=10){super(),this.target=t,this.panicDistance=e}calculate(t,e){const s=this.target;return t.position.squaredDistanceTo(s)<=this.panicDistance*this.panicDistance&&(K.subVectors(t.position,s).normalize(),0===K.squaredLength()&&K.set(0,0,1),K.multiplyScalar(t.maxSpeed),e.subVectors(K,t.velocity)),e}toJSON(){const t=super.toJSON();return t.target=this.target.toArray(new Array),t.panicDistance=this.panicDistance,t}fromJSON(t){return super.fromJSON(t),this.target.fromArray(t.target),this.panicDistance=t.panicDistance,this}}const j=new d,X=new d,Q=new d;class Z extends C{constructor(t=null,e=10,s=1){super(),this.pursuer=t,this.panicDistance=e,this.predictionFactor=s,this._flee=new Y}calculate(t,e){const s=this.pursuer;j.subVectors(s.position,t.position);let i=j.length()/(t.maxSpeed+s.getSpeed());return i*=this.predictionFactor,X.copy(s.velocity).multiplyScalar(i),Q.addVectors(s.position,X),this._flee.target=Q,this._flee.panicDistance=this.panicDistance,this._flee.calculate(t,e),e}toJSON(){const t=super.toJSON();return t.pursuer=this.pursuer?this.pursuer.uuid:null,t.panicDistance=this.panicDistance,t.predictionFactor=this.predictionFactor,t}fromJSON(t){return super.fromJSON(t),this.pursuer=t.pursuer,this.panicDistance=t.panicDistance,this.predictionFactor=t.predictionFactor,this}resolveReferences(t){this.pursuer=t.get(this.pursuer)||null}}class ${constructor(){this.loop=!1,this._waypoints=new Array,this._index=0}add(t){return this._waypoints.push(t),this}clear(){return this._waypoints.length=0,this._index=0,this}current(){return this._waypoints[this._index]}finished(){const t=this._waypoints.length-1;return!0!==this.loop&&this._index===t}advance(){return this._index++,this._index===this._waypoints.length&&(!0===this.loop?this._index=0:this._index--),this}toJSON(){const t={type:this.constructor.name,loop:this.loop,_waypoints:new Array,_index:this._index},e=this._waypoints;for(let s=0,i=e.length;s<i;s++){const i=e[s];t._waypoints.push(i.toArray(new Array))}return t}fromJSON(t){this.loop=t.loop,this._index=t._index;const e=t._waypoints;for(let t=0,s=e.length;t<s;t++){const s=e[t];this._waypoints.push((new d).fromArray(s))}return this}}class tt extends C{constructor(t=new $,e=1){super(),this.path=t,this.nextWaypointDistance=e,this._arrive=new q,this._seek=new H}calculate(t,e){const s=this.path;s.current().squaredDistanceTo(t.position)<this.nextWaypointDistance*this.nextWaypointDistance&&s.advance();const i=s.current();return!0===s.finished()?(this._arrive.target=i,this._arrive.calculate(t,e)):(this._seek.target=i,this._seek.calculate(t,e)),e}toJSON(){const t=super.toJSON();return t.path=this.path.toJSON(),t.nextWaypointDistance=this.nextWaypointDistance,t}fromJSON(t){return super.fromJSON(t),this.path.fromJSON(t.path),this.nextWaypointDistance=t.nextWaypointDistance,this}}const et=new d,st=new d,it=new d,rt=new d;class nt extends C{constructor(t=null,e=null,s=3){super(),this.entity1=t,this.entity2=e,this.deceleration=s,this._arrive=new q}calculate(t,e){const s=this.entity1,i=this.entity2;et.addVectors(s.position,i.position).multiplyScalar(.5);const r=t.position.distanceTo(et)/t.maxSpeed;return st.copy(s.velocity).multiplyScalar(r),it.addVectors(s.position,st),st.copy(i.velocity).multiplyScalar(r),rt.addVectors(i.position,st),et.addVectors(it,rt).multiplyScalar(.5),this._arrive.deceleration=this.deceleration,this._arrive.target=et,this._arrive.calculate(t,e),e}toJSON(){const t=super.toJSON();return t.entity1=this.entity1?this.entity1.uuid:null,t.entity2=this.entity2?this.entity2.uuid:null,t.deceleration=this.deceleration,t}fromJSON(t){return super.fromJSON(t),this.entity1=t.entity1,this.entity2=t.entity2,this.deceleration=t.deceleration,this}resolveReferences(t){this.entity1=t.get(this.entity1)||null,this.entity2=t.get(this.entity2)||null}}const ot=new d,at=new d,ht=new d,ct=[new d,new d,new d,new d,new d,new d,new d,new d];class lt{constructor(t=new d,e=new d){this.min=t,this.max=e}set(t,e){return this.min=t,this.max=e,this}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}clone(){return(new this.constructor).copy(this)}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max),e}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}expand(t){return this.min.min(t),this.max.max(t),this}getCenter(t){return t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return t.subVectors(this.max,this.min)}intersectsAABB(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsBoundingSphere(t){return this.clampPoint(t.center,ot),ot.squaredDistanceTo(t.center)<=t.radius*t.radius}intersectsPlane(t){const e=t.normal;this.getCenter(at),ht.subVectors(this.max,at);const s=ht.x*Math.abs(e.x)+ht.y*Math.abs(e.y)+ht.z*Math.abs(e.z),i=t.distanceToPoint(at);return Math.abs(i)<=s}getNormalFromSurfacePoint(t,e){let s;e.set(0,0,0);let i=1/0;return this.getCenter(at),this.getSize(ht),ot.copy(t).sub(at),s=Math.abs(ht.x-Math.abs(ot.x)),s<i&&(i=s,e.set(1*Math.sign(ot.x),0,0)),s=Math.abs(ht.y-Math.abs(ot.y)),s<i&&(i=s,e.set(0,1*Math.sign(ot.y),0)),s=Math.abs(ht.z-Math.abs(ot.z)),s<i&&e.set(0,0,1*Math.sign(ot.z)),e}fromCenterAndSize(t,e){return ot.copy(e).multiplyScalar(.5),this.min.copy(t).sub(ot),this.max.copy(t).add(ot),this}fromPoints(t){this.min.set(1/0,1/0,1/0),this.max.set(-1/0,-1/0,-1/0);for(let e=0,s=t.length;e<s;e++)this.expand(t[e]);return this}applyMatrix4(t){const e=this.min,s=this.max;return ct[0].set(e.x,e.y,e.z).applyMatrix4(t),ct[1].set(e.x,e.y,s.z).applyMatrix4(t),ct[2].set(e.x,s.y,e.z).applyMatrix4(t),ct[3].set(e.x,s.y,s.z).applyMatrix4(t),ct[4].set(s.x,e.y,e.z).applyMatrix4(t),ct[5].set(s.x,e.y,s.z).applyMatrix4(t),ct[6].set(s.x,s.y,e.z).applyMatrix4(t),ct[7].set(s.x,s.y,s.z).applyMatrix4(t),this.fromPoints(ct)}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}toJSON(){return{type:this.constructor.name,min:this.min.toArray(new Array),max:this.max.toArray(new Array)}}fromJSON(t){return this.min.fromArray(t.min),this.max.fromArray(t.max),this}}const ut=new lt;const dt=new d,pt=new d,mt=new d,yt=new d,gt=new d,xt=new N,ft=new N,wt=new lt;class St{constructor(t=new d,e=new d){this.origin=t,this.direction=e}set(t,e){return this.origin=t,this.direction=e,this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}clone(){return(new this.constructor).copy(this)}at(t,e){return e.copy(this.direction).multiplyScalar(t).add(this.origin)}intersectBoundingSphere(t,e){dt.subVectors(t.center,this.origin);const s=dt.dot(this.direction),i=dt.dot(dt)-s*s,r=t.radius*t.radius;if(i>r)return null;const n=Math.sqrt(r-i),o=s-n,a=s+n;return o<0&&a<0?null:o<0?this.at(a,e):this.at(o,e)}intersectsBoundingSphere(t){const e=new d;let s;const i=e.subVectors(t.center,this.origin).dot(this.direction);return i<0?s=this.origin.squaredDistanceTo(t.center):(e.copy(this.direction).multiplyScalar(i).add(this.origin),s=e.squaredDistanceTo(t.center)),s<=t.radius*t.radius}intersectAABB(t,e){let s,i,r,n,o,a;const h=1/this.direction.x,c=1/this.direction.y,l=1/this.direction.z,u=this.origin;return h>=0?(s=(t.min.x-u.x)*h,i=(t.max.x-u.x)*h):(s=(t.max.x-u.x)*h,i=(t.min.x-u.x)*h),c>=0?(r=(t.min.y-u.y)*c,n=(t.max.y-u.y)*c):(r=(t.max.y-u.y)*c,n=(t.min.y-u.y)*c),s>n||r>i?null:((r>s||s!=s)&&(s=r),(n<i||i!=i)&&(i=n),l>=0?(o=(t.min.z-u.z)*l,a=(t.max.z-u.z)*l):(o=(t.max.z-u.z)*l,a=(t.min.z-u.z)*l),s>a||o>i?null:((o>s||s!=s)&&(s=o),(a<i||i!=i)&&(i=a),i<0?null:this.at(s>=0?s:i,e)))}intersectsAABB(t){return null!==this.intersectAABB(t,dt)}intersectPlane(t,e){let s;const i=t.normal.dot(this.direction);if(0===i){if(0!==t.distanceToPoint(this.origin))return null;s=0}else s=-(this.origin.dot(t.normal)+t.constant)/i;return s>=0?this.at(s,e):null}intersectsPlane(t){const e=t.distanceToPoint(this.origin);if(0===e)return!0;return t.normal.dot(this.direction)*e<0}intersectOBB(t,e){return t.getSize(gt),wt.fromCenterAndSize(dt.set(0,0,0),gt),xt.fromMatrix3(t.rotation),xt.setPosition(t.center),Mt.copy(this).applyMatrix4(xt.getInverse(ft)),Mt.intersectAABB(wt,e)?e.applyMatrix4(xt):null}intersectsOBB(t){return null!==this.intersectOBB(t,dt)}intersectConvexHull(t,e){const s=t.faces;let i=-1/0,r=1/0;for(let t=0,e=s.length;t<e;t++){const e=s[t].plane,n=e.distanceToPoint(this.origin),o=e.normal.dot(this.direction);if(n>0&&o>=0)return null;const a=0!==o?-n/o:0;if(!(a<=0)&&(o>0?r=Math.min(a,r):i=Math.max(a,i),i>r))return null}return i!==-1/0?this.at(i,e):this.at(r,e),e}intersectsConvexHull(t){return null!==this.intersectConvexHull(t,dt)}intersectTriangle(t,e,s){const i=t.a,r=t.b,n=t.c;pt.subVectors(r,i),mt.subVectors(n,i),yt.crossVectors(pt,mt);let o,a=this.direction.dot(yt);if(a>0){if(e)return null;o=1}else{if(!(a<0))return null;o=-1,a=-a}dt.subVectors(this.origin,i);const h=o*this.direction.dot(mt.crossVectors(dt,mt));if(h<0)return null;const c=o*this.direction.dot(pt.cross(dt));if(c<0)return null;if(h+c>a)return null;const l=-o*dt.dot(yt);return l<0?null:this.at(l/a,s)}intersectBVH(t,e){return t.root.intersectRay(this,e)}intersectsBVH(t){return t.root.intersectsRay(this)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}}const Mt=new St,bt=new N,vt=new d,zt=new d,Et=new d,Ot=new class{constructor(t=new d,e=0){this.center=t,this.radius=e}set(t,e){return this.center=t,this.radius=e,this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}clone(){return(new this.constructor).copy(this)}clampPoint(t,e){e.copy(t);return this.center.squaredDistanceTo(t)>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}containsPoint(t){return t.squaredDistanceTo(this.center)<=this.radius*this.radius}intersectsBoundingSphere(t){const e=this.radius+t.radius;return t.center.squaredDistanceTo(this.center)<=e*e}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}getNormalFromSurfacePoint(t,e){return e.subVectors(t,this.center).normalize()}fromPoints(t){return ut.fromPoints(t),ut.getCenter(this.center),this.radius=this.center.distanceTo(ut.max),this}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScale(),this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}toJSON(){return{type:this.constructor.name,center:this.center.toArray(new Array),radius:this.radius}}fromJSON(t){return this.center.fromArray(t.center),this.radius=t.radius,this}},Nt=new St(new d(0,0,0),new d(0,0,1));class At extends C{constructor(t=new Array){super(),this.obstacles=t,this.brakingWeight=.2,this.dBoxMinLength=4}calculate(t,e){const s=this.obstacles;let i=null,r=1/0;const n=this.dBoxMinLength+t.getSpeed()/t.maxSpeed*this.dBoxMinLength;t.worldMatrix.getInverse(bt);for(let e=0,o=s.length;e<o;e++){const o=s[e];if(o!==t&&(vt.copy(o.position).applyMatrix4(bt),vt.z>0&&Math.abs(vt.z)<n)){const e=o.boundingRadius+t.boundingRadius;Math.abs(vt.x)<e&&(Ot.center.copy(vt),Ot.radius=e,Nt.intersectBoundingSphere(Ot,Et),Et.z<r&&(r=Et.z,i=o,zt.copy(vt)))}}if(null!==i){const s=1+(n-zt.z)/n;e.x=(i.boundingRadius-zt.x)*s,e.z=(i.boundingRadius-zt.z)*this.brakingWeight,e.applyRotation(t.rotation)}return e}toJSON(){const t=super.toJSON();t.obstacles=new Array,t.brakingWeight=this.brakingWeight,t.dBoxMinLength=this.dBoxMinLength;for(let e=0,s=this.obstacles.length;e<s;e++)t.obstacles.push(this.obstacles[e].uuid);return t}fromJSON(t){return super.fromJSON(t),this.obstacles=t.obstacles,this.brakingWeight=t.brakingWeight,this.dBoxMinLength=t.dBoxMinLength,this}resolveReferences(t){const e=this.obstacles;for(let s=0,i=e.length;s<i;s++)e[s]=t.get(e[s])}}const Tt=new d,Rt=new d,Lt=new d,kt=new d;class _t extends C{constructor(t=null,e=new d){super(),this.leader=t,this.offset=e,this._arrive=new q,this._arrive.deceleration=1.5}calculate(t,e){const s=this.leader,i=this.offset;Tt.copy(i).applyMatrix4(s.worldMatrix),Rt.subVectors(Tt,t.position);const r=Rt.length()/(t.maxSpeed+s.getSpeed());return Lt.copy(s.velocity).multiplyScalar(r),kt.addVectors(Tt,Lt),this._arrive.target=kt,this._arrive.calculate(t,e),e}toJSON(){const t=super.toJSON();return t.leader=this.leader?this.leader.uuid:null,t.offset=this.offset,t}fromJSON(t){return super.fromJSON(t),this.leader=t.leader,this.offset=t.offset,this}resolveReferences(t){this.leader=t.get(this.leader)||null}}const Jt=new d,Dt=new d,Ct=new d,Pt=new d,Ft=new d;class Vt extends C{constructor(t=null,e=1){super(),this.evader=t,this.predictionFactor=e,this._seek=new H}calculate(t,e){const s=this.evader;Jt.subVectors(s.position,t.position),t.getDirection(Dt),s.getDirection(Ct);const i=Jt.dot(Dt)>0,r=Dt.dot(Ct)<-.95;if(!0===i&&!0===r)return this._seek.target=s.position,this._seek.calculate(t,e),e;let n=Jt.length()/(t.maxSpeed+s.getSpeed());return n*=this.predictionFactor,Pt.copy(s.velocity).multiplyScalar(n),Ft.addVectors(s.position,Pt),this._seek.target=Ft,this._seek.calculate(t,e),e}toJSON(){const t=super.toJSON();return t.evader=this.evader?this.evader.uuid:null,t.predictionFactor=this.predictionFactor,t}fromJSON(t){return super.fromJSON(t),this.evader=t.evader,this.predictionFactor=t.predictionFactor,this}resolveReferences(t){this.evader=t.get(this.evader)||null}}const Bt=new d;class It extends C{constructor(){super()}calculate(t,e){const s=t.neighbors;for(let i=0,r=s.length;i<r;i++){const r=s[i];Bt.subVectors(t.position,r.position);let n=Bt.length();0===n&&(n=1e-4),Bt.normalize().divideScalar(n),e.add(Bt)}return e}}const qt=new d,Ut=new d;class Ht extends C{constructor(t=1,e=5,s=5){super(),this.radius=t,this.distance=e,this.jitter=s,this._targetLocal=new d,function(t,e){const s=Math.random()*Math.PI*2;e.x=t*Math.cos(s),e.z=t*Math.sin(s)}(this.radius,this._targetLocal)}calculate(t,e,s){const i=this.jitter*s;return Ut.x=u.randFloat(-1,1)*i,Ut.z=u.randFloat(-1,1)*i,this._targetLocal.add(Ut),this._targetLocal.normalize(),this._targetLocal.multiplyScalar(this.radius),qt.copy(this._targetLocal),qt.z+=this.distance,qt.applyMatrix4(t.worldMatrix),e.subVectors(qt,t.position),e}toJSON(){const t=super.toJSON();return t.radius=this.radius,t.distance=this.distance,t.jitter=this.jitter,t._targetLocal=this._targetLocal.toArray(new Array),t}fromJSON(t){return super.fromJSON(t),this.radius=t.radius,this.distance=t.distance,this.jitter=t.jitter,this._targetLocal.fromArray(t._targetLocal),this}}const Wt=new d;class Gt{constructor(t){this.vehicle=t,this.behaviors=new Array,this._steeringForce=new d,this._typesMap=new Map}add(t){return this.behaviors.push(t),this}remove(t){const e=this.behaviors.indexOf(t);return this.behaviors.splice(e,1),this}clear(){return this.behaviors.length=0,this}calculate(t,e){return this._calculateByOrder(t),e.copy(this._steeringForce)}_accumulate(t){const e=this._steeringForce.length(),s=this.vehicle.maxForce-e;if(s<=0)return!1;return t.length()>s&&t.normalize().multiplyScalar(s),this._steeringForce.add(t),!0}_calculateByOrder(t){const e=this.behaviors;this._steeringForce.set(0,0,0);for(let s=0,i=e.length;s<i;s++){const i=e[s];if(!0===i.active&&(Wt.set(0,0,0),i.calculate(this.vehicle,Wt,t),Wt.multiplyScalar(i.weight),!1===this._accumulate(Wt)))return}}toJSON(){const t={type:"SteeringManager",behaviors:new Array},e=this.behaviors;for(let s=0,i=e.length;s<i;s++){const i=e[s];t.behaviors.push(i.toJSON())}return t}fromJSON(t){this.clear();const e=t.behaviors;for(let t=0,s=e.length;t<s;t++){const s=e[t],i=s.type;let r;switch(i){case"SteeringBehavior":r=(new C).fromJSON(s);break;case"AlignmentBehavior":r=(new V).fromJSON(s);break;case"ArriveBehavior":r=(new q).fromJSON(s);break;case"CohesionBehavior":r=(new G).fromJSON(s);break;case"EvadeBehavior":r=(new Z).fromJSON(s);break;case"FleeBehavior":r=(new Y).fromJSON(s);break;case"FollowPathBehavior":r=(new tt).fromJSON(s);break;case"InterposeBehavior":r=(new nt).fromJSON(s);break;case"ObstacleAvoidanceBehavior":r=(new At).fromJSON(s);break;case"OffsetPursuitBehavior":r=(new _t).fromJSON(s);break;case"PursuitBehavior":r=(new Vt).fromJSON(s);break;case"SeekBehavior":r=(new H).fromJSON(s);break;case"SeparationBehavior":r=(new It).fromJSON(s);break;case"WanderBehavior":r=(new Ht).fromJSON(s);break;default:const t=this._typesMap.get(i);if(void 0===t){h.warn("YUKA.SteeringManager: Unsupported steering behavior type:",i);continue}r=(new t).fromJSON(s)}this.add(r)}return this}registerType(t,e){return this._typesMap.set(t,e),this}resolveReferences(t){const e=this.behaviors;for(let s=0,i=e.length;s<i;s++){e[s].resolveReferences(t)}return this}}class Kt{constructor(t=10){this.count=t,this._history=new Array,this._slot=0;for(let t=0;t<this.count;t++)this._history[t]=new d}calculate(t,e){e.set(0,0,0),this._slot===this.count&&(this._slot=0),this._history[this._slot].copy(t),this._slot++;for(let t=0;t<this.count;t++)e.add(this._history[t]);return e.divideScalar(this.count),e}toJSON(){const t={type:this.constructor.name,count:this.count,_history:new Array,_slot:this._slot},e=this._history;for(let s=0,i=e.length;s<i;s++){const i=e[s];t._history.push(i.toArray(new Array))}return t}fromJSON(t){this.count=t.count,this._slot=t._slot;const e=t._history;this._history.length=0;for(let t=0,s=e.length;t<s;t++){const s=e[t];this._history.push((new d).fromArray(s))}return this}}const Yt=new d,jt=new d,Xt=new d,Qt=new d,Zt=new d;class $t extends D{constructor(){super(),this.mass=1,this.maxForce=100,this.steering=new Gt(this),this.smoother=null}update(t){return this.steering.calculate(t,Yt),Xt.copy(Yt).divideScalar(this.mass),this.velocity.add(Xt.multiplyScalar(t)),this.getSpeedSquared()>this.maxSpeed*this.maxSpeed&&(this.velocity.normalize(),this.velocity.multiplyScalar(this.maxSpeed)),jt.copy(this.velocity).multiplyScalar(t),Qt.copy(this.position).add(jt),!0===this.updateOrientation&&null===this.smoother&&this.getSpeedSquared()>1e-8&&this.lookAt(Qt),this.position.copy(Qt),!0===this.updateOrientation&&null!==this.smoother&&(this.smoother.calculate(this.velocity,Zt),jt.copy(Zt).multiplyScalar(t),Qt.copy(this.position).add(jt),this.lookAt(Qt)),this}toJSON(){const t=super.toJSON();return t.mass=this.mass,t.maxForce=this.maxForce,t.steering=this.steering.toJSON(),t.smoother=this.smoother?this.smoother.toJSON():null,t}fromJSON(t){return super.fromJSON(t),this.mass=t.mass,this.maxForce=t.maxForce,this.steering=new Gt(this).fromJSON(t.steering),this.smoother=t.smoother?(new Kt).fromJSON(t.smoother):null,this}resolveReferences(t){super.resolveReferences(t),this.steering.resolveReferences(t)}}new Array;class te{clearDegreeOfMembership(){}getDegreeOfMembership(){}updateDegreeOfMembership(){}toJSON(){return{type:this.constructor.name}}}class ee extends te{constructor(t=new Array){super(),this.terms=t}clearDegreeOfMembership(){const t=this.terms;for(let e=0,s=t.length;e<s;e++)t[e].clearDegreeOfMembership();return this}updateDegreeOfMembership(t){const e=this.terms;for(let s=0,i=e.length;s<i;s++)e[s].updateDegreeOfMembership(t);return this}toJSON(){const t=super.toJSON();t.terms=new Array;for(let e=0,s=this.terms.length;e<s;e++){const s=this.terms[e];s instanceof ee?t.terms.push(s.toJSON()):t.terms.push(s.uuid)}return t}}class se extends ee{constructor(){super(Array.from(arguments))}getDegreeOfMembership(){const t=this.terms;let e=1/0;for(let s=0,i=t.length;s<i;s++){const i=t[s].getDegreeOfMembership();i<e&&(e=i)}return e}}class ie extends ee{constructor(t=null){super(null!==t?[t]:new Array)}clearDegreeOfMembership(){return this.terms[0].clearDegreeOfMembership(),this}getDegreeOfMembership(){const t=this.terms[0].getDegreeOfMembership();return Math.sqrt(t)}updateDegreeOfMembership(t){return this.terms[0].updateDegreeOfMembership(Math.sqrt(t)),this}}class re extends ee{constructor(){super(Array.from(arguments))}getDegreeOfMembership(){const t=this.terms;let e=-1/0;for(let s=0,i=t.length;s<i;s++){const i=t[s].getDegreeOfMembership();i>e&&(e=i)}return e}}class ne extends ee{constructor(t=null){super(null!==t?[t]:new Array)}clearDegreeOfMembership(){return this.terms[0].clearDegreeOfMembership(),this}getDegreeOfMembership(){const t=this.terms[0].getDegreeOfMembership();return t*t}updateDegreeOfMembership(t){return this.terms[0].updateDegreeOfMembership(t*t),this}}class oe extends te{constructor(t=0){super(),this.degreeOfMembership=0,this.representativeValue=t,this.left=0,this.right=0,this._uuid=null}get uuid(){return null===this._uuid&&(this._uuid=u.generateUUID()),this._uuid}set uuid(t){this._uuid=t}computeDegreeOfMembership(){}clearDegreeOfMembership(){return this.degreeOfMembership=0,this}getDegreeOfMembership(){return this.degreeOfMembership}updateDegreeOfMembership(t){return t>this.degreeOfMembership&&(this.degreeOfMembership=t),this}toJSON(){const t=super.toJSON();return t.degreeOfMembership=this.degreeOfMembership,t.representativeValue=this.representativeValue,t.left=this.left,t.right=this.right,t.uuid=this.uuid,t}fromJSON(t){return this.degreeOfMembership=t.degreeOfMembership,this.representativeValue=t.representativeValue,this.left=t.left,this.right=t.right,this.uuid=t.uuid,this}}class ae extends oe{constructor(t=0,e=0,s=0){super((e+t)/2),this.left=t,this.midpoint=e,this.right=s}computeDegreeOfMembership(t){const e=this.midpoint,s=this.left,i=this.right;if(t>=s&&t<=e)return 1;if(t>e&&t<=i){return 1/(i-e)*(i-t)}return 0}toJSON(){const t=super.toJSON();return t.midpoint=this.midpoint,t}fromJSON(t){return super.fromJSON(t),this.midpoint=t.midpoint,this}}class he extends oe{constructor(t=0,e=0,s=0){super((e+s)/2),this.left=t,this.midpoint=e,this.right=s}computeDegreeOfMembership(t){const e=this.midpoint,s=this.left,i=this.right;if(t>=s&&t<=e){return 1/(e-s)*(t-s)}return t>e&&t<=i?1:0}toJSON(){const t=super.toJSON();return t.midpoint=this.midpoint,t}fromJSON(t){return super.fromJSON(t),this.midpoint=t.midpoint,this}}class ce extends oe{constructor(t=0,e=0,s=0){super(e),this.left=t,this.midpoint=e,this.right=s}computeDegreeOfMembership(t){const e=this.left,s=this.right;return t>=e&&t<=s?1:0}toJSON(){const t=super.toJSON();return t.midpoint=this.midpoint,t}fromJSON(t){return super.fromJSON(t),this.midpoint=t.midpoint,this}}class le extends oe{constructor(t=0,e=0,s=0){super(e),this.left=t,this.midpoint=e,this.right=s}computeDegreeOfMembership(t){const e=this.midpoint,s=this.left,i=this.right;if(t>=s&&t<=e){return 1/(e-s)*(t-s)}if(t>e&&t<=i){return 1/(i-e)*(i-t)}return 0}toJSON(){const t=super.toJSON();return t.midpoint=this.midpoint,t}fromJSON(t){return super.fromJSON(t),this.midpoint=t.midpoint,this}}class ue{constructor(t=null,e=null){this.antecedent=t,this.consequence=e}initConsequence(){return this.consequence.clearDegreeOfMembership(),this}evaluate(){return this.consequence.updateDegreeOfMembership(this.antecedent.getDegreeOfMembership()),this}toJSON(){const t={},e=this.antecedent,s=this.consequence;return t.type=this.constructor.name,t.antecedent=e instanceof ee?e.toJSON():e.uuid,t.consequence=s instanceof ee?s.toJSON():s.uuid,t}fromJSON(t,e){function s(t){if("string"==typeof t){const s=t;return e.get(s)||null}{const e=t.type;let i;switch(e){case"FuzzyAND":i=new se;break;case"FuzzyOR":i=new re;break;case"FuzzyVERY":i=new ne;break;case"FuzzyFAIRLY":i=new ie;break;default:return void h.error("YUKA.FuzzyRule: Unsupported operator type:",e)}const r=t.terms;for(let t=0,e=r.length;t<e;t++)i.terms.push(s(r[t]));return i}}return this.antecedent=s(t.antecedent),this.consequence=s(t.consequence),this}}class de{constructor(){this.fuzzySets=new Array,this.minRange=1/0,this.maxRange=-1/0}add(t){return this.fuzzySets.push(t),t.left<this.minRange&&(this.minRange=t.left),t.right>this.maxRange&&(this.maxRange=t.right),this}remove(t){const e=this.fuzzySets,s=e.indexOf(t);e.splice(s,1),this.minRange=1/0,this.maxRange=-1/0;for(let t=0,s=e.length;t<s;t++){const s=e[t];s.left<this.minRange&&(this.minRange=s.left),s.right>this.maxRange&&(this.maxRange=s.right)}return this}fuzzify(t){if(t<this.minRange||t>this.maxRange)return void h.warn("YUKA.FuzzyVariable: Value for fuzzification out of range.");const e=this.fuzzySets;for(let s=0,i=e.length;s<i;s++){const i=e[s];i.degreeOfMembership=i.computeDegreeOfMembership(t)}return this}defuzzifyMaxAv(){const t=this.fuzzySets;let e=0,s=0;for(let i=0,r=t.length;i<r;i++){const r=t[i];e+=r.degreeOfMembership,s+=r.representativeValue*r.degreeOfMembership}return 0===e?0:s/e}defuzzifyCentroid(t=10){const e=this.fuzzySets,s=(this.maxRange-this.minRange)/t;let i=0,r=0;for(let n=1;n<=t;n++){const t=this.minRange+n*s;for(let s=0,n=e.length;s<n;s++){const n=e[s],o=Math.min(n.degreeOfMembership,n.computeDegreeOfMembership(t));i+=o,r+=t*o}}return 0===i?0:r/i}toJSON(){const t={type:this.constructor.name,fuzzySets:new Array,minRange:this.minRange.toString(),maxRange:this.maxRange.toString()};for(let e=0,s=this.fuzzySets.length;e<s;e++){const s=this.fuzzySets[e];t.fuzzySets.push(s.toJSON())}return t}fromJSON(t){this.minRange=parseFloat(t.minRange),this.maxRange=parseFloat(t.maxRange);for(let e=0,s=t.fuzzySets.length;e<s;e++){const s=t.fuzzySets[e];switch(s.type){case"LeftShoulderFuzzySet":this.fuzzySets.push((new ae).fromJSON(s));break;case"RightShoulderFuzzySet":this.fuzzySets.push((new he).fromJSON(s));break;case"SingletonFuzzySet":this.fuzzySets.push((new ce).fromJSON(s));break;case"TriangularFuzzySet":this.fuzzySets.push((new le).fromJSON(s));break;default:h.error("YUKA.FuzzyVariable: Unsupported fuzzy set type:",s.type)}}return this}}class pe{constructor(){this.rules=new Array,this.flvs=new Map}addFLV(t,e){return this.flvs.set(t,e),this}removeFLV(t){return this.flvs.delete(t),this}addRule(t){return this.rules.push(t),this}removeRule(t){const e=this.rules,s=e.indexOf(t);return e.splice(s,1),this}fuzzify(t,e){return this.flvs.get(t).fuzzify(e),this}defuzzify(t,e=pe.DEFUZ_TYPE.MAXAV){const s=this.flvs,i=this.rules;this._initConsequences();for(let t=0,e=i.length;t<e;t++){i[t].evaluate()}const r=s.get(t);let n;switch(e){case pe.DEFUZ_TYPE.MAXAV:n=r.defuzzifyMaxAv();break;case pe.DEFUZ_TYPE.CENTROID:n=r.defuzzifyCentroid();break;default:h.warn("YUKA.FuzzyModule: Unknown defuzzification method:",e),n=r.defuzzifyMaxAv()}return n}_initConsequences(){const t=this.rules;for(let e=0,s=t.length;e<s;e++){t[e].initConsequence()}return this}toJSON(){const t={rules:new Array,flvs:new Array},e=this.rules;for(let s=0,i=e.length;s<i;s++)t.rules.push(e[s].toJSON());const s=this.flvs;for(let[e,i]of s)t.flvs.push({name:e,flv:i.toJSON()});return t}fromJSON(t){const e=new Map,s=t.flvs;for(let t=0,i=s.length;t<i;t++){const i=s[t],r=i.name,n=(new de).fromJSON(i.flv);this.addFLV(r,n);for(let t of n.fuzzySets)e.set(t.uuid,t)}const i=t.rules;for(let t=0,s=i.length;t<s;t++){const s=i[t],r=(new ue).fromJSON(s,e);this.addRule(r)}return this}}pe.DEFUZ_TYPE=Object.freeze({MAXAV:0,CENTROID:1});class me{constructor(t=null){this.owner=t,this.status=me.STATUS.INACTIVE}activate(){}execute(){}terminate(){}handleMessage(){return!1}active(){return this.status===me.STATUS.ACTIVE}inactive(){return this.status===me.STATUS.INACTIVE}completed(){return this.status===me.STATUS.COMPLETED}failed(){return this.status===me.STATUS.FAILED}replanIfFailed(){return!0===this.failed()&&(this.status=me.STATUS.INACTIVE),this}activateIfInactive(){return!0===this.inactive()&&(this.status=me.STATUS.ACTIVE,this.activate()),this}toJSON(){return{type:this.constructor.name,owner:this.owner.uuid,status:this.status}}fromJSON(t){return this.owner=t.owner,this.status=t.status,this}resolveReferences(t){return this.owner=t.get(this.owner)||null,this}}me.STATUS=Object.freeze({ACTIVE:"active",INACTIVE:"inactive",COMPLETED:"completed",FAILED:"failed"});class ye extends me{constructor(t=null){super(t),this.subgoals=new Array}addSubgoal(t){return this.subgoals.unshift(t),this}removeSubgoal(t){const e=this.subgoals.indexOf(t);return this.subgoals.splice(e,1),this}clearSubgoals(){const t=this.subgoals;for(let e=0,s=t.length;e<s;e++){t[e].terminate()}return t.length=0,this}currentSubgoal(){const t=this.subgoals.length;return t>0?this.subgoals[t-1]:null}executeSubgoals(){const t=this.subgoals;for(let e=t.length-1;e>=0;e--){const s=t[e];if(!0!==s.completed()&&!0!==s.failed())break;s instanceof ye&&s.clearSubgoals(),s.terminate(),t.pop()}const e=this.currentSubgoal();return null!==e?(e.activateIfInactive(),e.execute(),!0===e.completed()&&t.length>1?me.STATUS.ACTIVE:e.status):me.STATUS.COMPLETED}hasSubgoals(){return this.subgoals.length>0}handleMessage(t){const e=this.currentSubgoal();return null!==e&&e.handleMessage(t)}toJSON(){const t=super.toJSON();t.subgoals=new Array;for(let e=0,s=this.subgoals.length;e<s;e++){const s=this.subgoals[e];t.subgoals.push(s.toJSON())}return t}resolveReferences(t){super.resolveReferences(t);for(let e=0,s=this.subgoals.length;e<s;e++){this.subgoals[e].resolveReferences(t)}return this}}class ge{constructor(t=1){this.characterBias=t}calculateDesirability(){return 0}setGoal(){}toJSON(){return{type:this.constructor.name,characterBias:this.characterBias}}fromJSON(t){return this.characterBias=t.characterBias,this}}class xe extends ye{constructor(t=null){super(t),this.evaluators=new Array,this._typesMap=new Map}activate(){this.arbitrate()}execute(){this.activateIfInactive();const t=this.executeSubgoals();t!==me.STATUS.COMPLETED&&t!==me.STATUS.FAILED||(this.status=me.STATUS.INACTIVE)}terminate(){this.clearSubgoals()}addEvaluator(t){return this.evaluators.push(t),this}removeEvaluator(t){const e=this.evaluators.indexOf(t);return this.evaluators.splice(e,1),this}arbitrate(){const t=this.evaluators;let e=-1,s=null;for(let i=0,r=t.length;i<r;i++){const r=t[i];let n=r.calculateDesirability(this.owner);n*=r.characterBias,n>=e&&(e=n,s=r)}return null!==s?s.setGoal(this.owner):h.error("YUKA.Think: Unable to determine goal evaluator for game entity:",this.owner),this}toJSON(){const t=super.toJSON();t.evaluators=new Array;for(let e=0,s=this.evaluators.length;e<s;e++){const s=this.evaluators[e];t.evaluators.push(s.toJSON())}return t}fromJSON(t){super.fromJSON(t);const e=this._typesMap;this.evaluators.length=0,this.terminate();for(let s=0,i=t.evaluators.length;s<i;s++){const i=t.evaluators[s],r=i.type,n=e.get(r);if(void 0!==n){const t=(new n).fromJSON(i);this.evaluators.push(t)}else h.warn("YUKA.Think: Unsupported goal evaluator type:",r)}function s(t){const i=t.type,r=e.get(i);if(void 0!==r){const e=(new r).fromJSON(t),i=t.subgoals;if(void 0!==i)for(let t=0,r=i.length;t<r;t++){const r=s(i[t]);r&&e.subgoals.push(r)}return e}h.warn("YUKA.Think: Unsupported goal evaluator type:",i)}for(let e=0,i=t.subgoals.length;e<i;e++){const i=s(t.subgoals[e]);i&&this.subgoals.push(i)}return this}registerType(t,e){return this._typesMap.set(t,e),this}}new Array,new Array,new Array;class fe extends ye{constructor(t){super(t),this.GATHER="GATHER",this.localPosition=new YUKA.Vector3}activate(){console.log("INVERSEmat"),this.addSubgoal(new we(this.owner)),this.addSubgoal(new Se(this.owner)),this.addSubgoal(new Me(this.owner))}execute(){this.status=this.executeSubgoals(),this.replanIfFailed()}}class we extends me{constructor(t){super(t),this.FIND_NEXT="FIND NEXT",console.log("INVERSEmatty"),this.inverseMatrix=new YUKA.Matrix4,console.log(new YUKA.Matrix4),console.log("///////////////////////"),this.localPosition=new YUKA.Vector3,this.animationId=null,console.log("Owner Constructor"),console.log(this.owner)}activate(){const t=this.owner;console.log("Owner Activation"),console.log(t);const e=t.manager.entities;let s=1/0;for(let i=0,r=e.length;i<r;i++){const r=e[i];if(r!==t){const e=t.position.squaredDistanceTo(r.position);e<s&&(s=e,t.currentTarget=r)}}console.log(this.localPosition),t.updateWorldMatrix(),console.log(t.worldMatrix),console.log("/////////////"),t.worldMatrix.getInverse(this.inverseMatrix),console.log(this.inverseMatrix),this.localPosition.copy(t.currentTarget.position).applyMatrix4(this.inverseMatrix),console.log(this.localPosition)}execute(){const t=this.owner;null!==t.currentTarget?!0===t.rotateTo(t.currentTarget.position,t.deltaTime)&&(this.status=me.STATUS.COMPLETED):this.status=me.STATUS.FAILED}terminate(){this.owner}}class Se extends me{constructor(t){super(t),this.SEEK="SEEK",this.PICK_UP="PICK UP",this.PLACEHOLDER="-",this.WALK="WALK",this.RIGHT_TURN="RIGHT_TURN",this.LEFT_TURN="LEFT_TURN",this.IDLE="IDLE",this.inverseMatrix=new YUKA.Matrix4,this.localPosition=new YUKA.Vector3}activate(){const t=this.owner;if(null!==t.currentTarget){const e=t.steering.behaviors[0];e.target=t.currentTarget.position,e.active=!0}else this.status=me.STATUS.FAILED}execute(){if(this.active()){const t=this.owner;t.position.squaredDistanceTo(t.currentTarget.position)<.25&&(this.status=me.STATUS.COMPLETED)}}terminate(){this.owner.steering.behaviors[0].active=!1,this.owner.velocity.set(0,0,0);this.owner}}class Me extends me{constructor(t){super(t),this.REST="REST",this.GATHER="GATHER",this.FIND_NEXT="FIND NEXT",this.SEEK="SEEK",this.PICK_UP="PICK UP",this.PLACEHOLDER="-",this.WALK="WALK",this.RIGHT_TURN="RIGHT_TURN",this.LEFT_TURN="LEFT_TURN",this.IDLE="IDLE",this.inverseMatrix=new YUKA.Matrix4,this.localPosition=new YUKA.Vector3,this.collectibleRemoveTimeout=3}activate(){const t=this.owner;t.animations.get(this.GATHER).reset().fadeIn(t.crossFadeDuration)}execute(){const t=this.owner;t.currentTime+=t.tickDelta,t.currentTime>=t.pickUpDuration?this.status=me.STATUS.COMPLETED:t.currentTime>=this.collectibleRemoveTimeout&&null!==t.currentTarget&&(t.sendMessage(t.currentTarget,"PickedUp"),t.currentTarget=null)}terminate(){const t=this.owner;t.currentTime=0,t.fatigueLevel++}}class be extends ge{calculateDesirability(){return.5}setGoal(t){t.brain.currentSubgoal()instanceof fe==!1&&(t.brain.clearSubgoals(),t.brain.addSubgoal(new fe(t)))}}class ve extends me{constructor(t){super(t),this.REST="REST",this.PLACEHOLDER="-"}activate(){}execute(){this.owner.currentTime+=this.owner.tickDelta,this.owner.currentTime>=this.owner.restDuration&&(this.status=me.STATUS.COMPLETED)}terminate(){this.owner.currentTime=0,this.fatigueLevel=0}}class ze extends ge{calculateDesirability(t){return!0===t.tired()?1:0}setGoal(t){t.brain.currentSubgoal()instanceof ve==!1&&(t.brain.clearSubgoals(),t.brain.addSubgoal(new ve(t)))}}t.BasicCube=class extends n{constructor(t,e={body:new CANNON.Body({shape:new CANNON.Box(new CANNON.Vec3(.5,.5,.5)),mass:4}),mesh:new THREE.Mesh(new THREE.BoxBufferGeometry(1,1,1),new THREE.MeshToonMaterial({color:5286128}))}){super(t,e)}},t.BasicSphere=class extends n{constructor(t,e={body:new CANNON.Body({shape:new CANNON.Sphere(1),mass:4}),mesh:new THREE.Mesh(new THREE.SphereBufferGeometry(1,64,64),new THREE.MeshToonMaterial({color:5286128}))}){super(t,e),this.mesh.castShadow=!0,this.mesh.recieveShadow=!1}},t.BasicTorus=class extends n{constructor(t,e={body:new CANNON.Body({shape:CANNON.Trimesh.createTorus(5,1,16,16),mass:1}),mesh:new THREE.Mesh(new THREE.TorusBufferGeometry(5,1,16,16),new THREE.MeshToonMaterial({color:5286128}))}){super(t,e)}},t.Bee=class extends $t{constructor(t){super(),this.maxTurnRate=.5*Math.PI,this.maxSpeed=1.5,this.mixer=t,this.ui={},this.brain=new xe(this),this.brain.addEvaluator(new ze),this.brain.addEvaluator(new be);const e=new q;e.deceleration=1.5,this.steering.add(e),this.fatigueLevel=0,this.restDuration=5,this.pickUpDuration=6,this.crossFadeDuration=.5,this.currentTarget=null,this.currentTime=0,this.deltaTime=0,this.position=new d(0,1,0),this.MAX_FATIGUE=3,console.log(this),console.log(1)}update(t){super.update(t),this.deltaTime=t,this.brain.execute(),this.brain.arbitrate()}tired(){return this.fatigueLevel>=this.MAX_FATIGUE}},t.Character=class extends n{constructor(t,e,s={body:new CANNON.Body({shape:new CANNON.Box(new CANNON.Vec3(.5,.5,.5)),mass:5}),mesh:new THREE.Object3D}){super(t,s),this.mesh.add(e),e.position.set(0,5,-3),this.speed=20,this.model=new THREE.Mesh(new THREE.BoxBufferGeometry(1,1,1),new THREE.MeshLambertMaterial({color:16777215})),this.mesh.add(this.model),this.controls=new a(e),this.vMagLine={geom:new THREE.Geometry,mat:new THREE.LineBasicMaterial({color:16711680}),m:null},this.vMagLine.geom.vertices.push(new THREE.Vector3,this.body.velocity),this.vMagLine.geom.verticesNeedUpdate=!0,this.vMagLine.m=new THREE.Line(this.vMagLine.geom,this.vMagLine.mat),this.vMagLine.m.position.setY(2),this.mesh.add(this.vMagLine.m)}updatePosition(){this.mesh.position.copy(this.body.position),this.model.quaternion.copy(this.body.quaternion)}update(){this.currSpeed=this.speed-Math.pow(.001,this.creation.tickDelta),this.body.applyForce(this.controls.getForce().multiplyScalar(this.currSpeed),this.body.pointToWorldFrame(new CANNON.Vec3)),this.vMagLine.geom.verticesNeedUpdate=!0,this.updatePosition()}},t.Collectible=class extends L{spawn(){this.position.x=15*Math.random()-7.5,this.position.z=15*Math.random()-7.5,this.position.x<1&&this.position.x>-1&&(this.position.x+=1),this.position.z<1&&this.position.y>-1&&(this.position.z+=1)}handleMessage(t){switch(t.message){case"PickedUp":return this.spawn(),!0;default:console.warn("Collectible: Unknown message.")}return!1}},t.Controls=a,t.CoreSphere=o,t.Creation=class{constructor(t={}){this.canvas=t.canvasId?document.querySelector("#"+t.canvasId):document.body,this.renderer=new THREE.WebGLRenderer({canvas:this.canvas}),this.renderer.shadowMap.enabled=!t.shadowMapEnabled||t.shadowMapEnabled,this.renderer.shadowMap.enabled&&(this.renderer.shadowMap.type=THREE.BasicShadowMap),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.toneMapping=THREE.ACESFilmicToneMapping,this.renderer.toneMappingExposure=1,this.renderer.outputEncoding=THREE.sRGBEncoding,this.mtlLoader=new THREE.MTLLoader,this.objLoader=new THREE.OBJLoader,this.texLoader=new THREE.TextureLoader,this.collmeshlist=[],this.clock=new THREE.Clock,this.tick=this.clock.getElapsedTime(),this.lastTick=this.tick,this.tickDelta=null,this.menuManager=t.menuManager?t.menuManager:new e(this),this.episodeManager=t.episodeManager?t.episodeManager:new s(this)}setMenuManager(t){this.menuManager=t}setEpisodeManager(t){this.episodeManager=t}tickUpdate(){this.tick=this.clock.getElapsedTime(),this.tickDelta=this.tick-this.lastTick,this.lastTick=this.tick}start(){this.episodeManager.start(),requestAnimationFrame((()=>this.render()))}render(){this.tickUpdate(),this.episodeManager.render(),window.requestAnimationFrame((()=>this.render()))}},t.Enemy=class extends n{constructor(t,e,s={mesh:new THREE.Object3D}){s.model=new o(t,{texture:"./node_modules/ouro-engine/src/assets/textures/explosion.png",detail:16}),s.body=s.model.body,super(t,s),this.model=s.model,this.mesh.add(this.model.mesh),this.speed=30,this.controls=new a(t,e,this.model.mesh),this.vMagLine={geom:new THREE.Geometry,mat:new THREE.LineBasicMaterial({color:16711680}),m:null},this.vMagLine.geom.vertices.push(new THREE.Vector3,this.body.velocity),this.vMagLine.geom.verticesNeedUpdate=!0,this.vMagLine.m=new THREE.Line(this.vMagLine.geom,this.vMagLine.mat),this.vMagLine.m.position.setY(2),this.mesh.add(this.vMagLine.m)}applyForce(t){this.a.add(t.divideScalar(this.body.mass))}updatePosition(){this.mesh.position.copy(this.body.position),this.model.mesh.quaternion.copy(this.body.quaternion)}update(){this.currSpeed=this.speed-Math.pow(.001,this.creation.tickDelta),this.controls.update(),this.body.applyForce(this.controls.getForce().multiplyScalar(this.currSpeed),this.body.pointToWorldFrame(new CANNON.Vec3)),this.model.update(),this.vMagLine.geom.verticesNeedUpdate=!0,this.updatePosition()}},t.EpisodeManager=s,t.EpisodeSkeleton=class{constructor(t,e={}){this.creation=t,this.name=e.name?e.name:"Episode",this.sceneManager=e.sceneManager?e.sceneManager:new i(this.creation)}nextScene(){this.sceneManager.loadNextScene(),this.sceneManager.iterateScene()}goToScene(t){this.sceneManager.index=t,this.sceneManager.setNextScene(t),this.nextScene()}start(){this.sceneManager.start()}stop(){this.sceneManager.stop()}render(){this.sceneManager.render()}},t.GatherEvaluator=be,t.GatherGoal=fe,t.MenuManager=e,t.ObjectBase=n,t.PlayableScene=class extends r{constructor(t,e){super(t,e),this.player=null}update(){let t=1-Math.pow(.001,this.creation.tickDelta),e=this.player.body.position.clone();e=e.scale(-1),this.scene.position.lerp(new THREE.Vector3(e.x,e.y,e.z),t)}},t.RestEvaluator=ze,t.RestGoal=ve,t.SceneManager=i,t.SceneSkeleton=r,t.Utils=class{static getCenterPoint(t){let e=t.geometry;e.computeBoundingBox(),console.log(e);let s=e.boundingBox.getCenter(new THREE.Vector3);return console.log(s),t.localToWorld(s),console.log(s),s}},Object.defineProperty(t,"__esModule",{value:!0})}));
